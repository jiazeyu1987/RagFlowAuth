# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Tool Directory (tool/)

This directory contains deployment automation tools and utilities for RagflowAuth. These are Windows-focused PowerShell and Python scripts for building, packaging, deploying, and maintaining RagflowAuth installations.

### Architecture

The tool directory is organized around three main workflows:

1. **Remote Deployment** (`deploy.ps1`, `deploy-quick.bat`, `scripts/remote-deploy.sh`)
   - Builds Docker images locally
   - Exports images to tar files with SHA256 checksums
   - Transfers to remote Linux server via SCP
   - Executes server-side deployment script

2. **Release Packaging** (`release_packager_ui.py`)
   - Creates distributable release ZIP files
   - Bundles auth DB, RAGFlow docker-compose data, and application files
   - Supports local or network share output

3. **Installation & Migration** (`release_installer_ui.py`, `migration_restore_ui.py`)
   - `release_installer_ui.py`: One-click deployment from release ZIP to Docker
   - `migration_restore_ui.py`: Restore backup/migration packs to running system
   - `setup_backup_share_ui.py`: Configure Windows SMB shares for backup

### Key Files

- **deploy.ps1**: Main deployment script (PowerShell)
  - Usage: `.\deploy.ps1` or `.\deploy.ps1 -Tag "v1.0.0" -ServerHost "192.168.1.100"`
  - Steps: Build → Export → Transfer → Deploy → Cleanup
  - Parameters: `-Tag`, `-ServerHost`, `-ServerUser`, `-SkipBuild`, `-SkipTransfer`, `-SkipDeploy`, `-SkipCleanup`, `-OutDir`

- **deploy-quick.bat**: Quick launcher (double-click to run)
  - Uses default config from `deploy-config.json`

- **deploy-config.json**: Default deployment configuration
  - Server host, user, Docker tag, ports, network settings
  - RAGFlow API key and base URL

- **scripts/remote-deploy.sh**: Server-side deployment script (Bash)
  - Loaded onto remote server and executed via SSH
  - Handles Docker load, container orchestration, network setup
  - Creates data directories and mounts volumes
  - Default server paths: `/opt/ragflowauth/`

### Python UI Tools

All UI tools are single-file Tkinter applications:

- **release_packager_ui.py** (v0.3.1)
  - Creates timestamped release ZIP: `RagflowAuth_release_YYYYMMDD_HHMMSS.zip`
  - Includes: auth DB, uploads, RAGFlow compose data, application files
  - Output: local folder or network UNC path

- **release_installer_ui.py** (v0.5.0)
  - Deploys from release ZIP to local Docker
  - Auto-detects bundled migration pack and RAGFlow compose
  - Creates Docker volumes, containers, and network
  - Generates random JWT secret on install

- **migration_restore_ui.py** (v0.2.0)
  - Restores backup to running Docker system
  - Handles volume name inference and matching
  - Supports both auth DB and RAGFlow volume restoration

- **setup_backup_share_ui.py**
  - Configures Windows firewall for SMB file sharing
  - Creates network shares for backup destinations
  - Requires admin privileges (auto-elevates)

### Data Persistence

Server deployment mounts these volumes:
- `/opt/ragflowauth/data` → SQLite auth DB
- `/opt/ragflowauth/uploads` → User uploads
- `/opt/ragflowauth/ragflow_config.json` → RAGFlow configuration (read-only)

### Common Workflows

**Deploy to remote server:**
```powershell
cd tool
.\deploy.ps1
```

**Build only, skip deployment:**
```powershell
.\deploy.ps1 -SkipTransfer -SkipDeploy -SkipCleanup
```

**Create release package:**
```bash
python tool/release_packager_ui.py
```

**Deploy from release ZIP:**
```bash
python tool/release_installer_ui.py
```

**Restore backup:**
```bash
python tool/migration_restore_ui.py
```

### Configuration Files

- **deploy-config.json**: Deployment defaults (server, Docker settings, RAGFlow config)
- **ragflow_config.json** (repo root): RAGFlow API connection settings
- **backup_config.json** (repo root, generated by `python -m backend init-backup`): Backup destination settings

### Server Management

After deployment, manage containers via SSH:
```bash
ssh root@<server>

# View containers
docker ps | grep ragflowauth

# View logs
docker logs -f ragflowauth-backend
docker logs -f ragflowauth-frontend

# Restart services
docker restart ragflowauth-backend ragflowauth-frontend

# Update configuration
vi /opt/ragflowauth/ragflow_config.json
docker restart ragflowauth-backend
```

### Troubleshooting

- **Docker connection issues**: Ensure Docker Desktop Linux engine is running
- **SSH connection failures**: Verify OpenSSH client enabled (Windows Settings → Apps → Optional Features)
- **Container startup failures**: Check logs via `docker logs ragflowauth-backend`
- **Port conflicts**: Modify ports in `deploy-config.json` or use `-FrontendPort`/`-BackendPort` parameters

### Related Documentation

- `DEPLOY.md`: Complete deployment guide with troubleshooting
- `DEPLOY-TOOLS-README.md`: Quick start guide
- `../CLAUDE.md`: Main project documentation
- `../backend/README.md`: Backend architecture and permission model
- `../docker/DOCKER_DEPLOY.md`: Docker deployment instructions
