# RagflowAuth 灾难恢复分析

## 当前备份恢复机制覆盖范围

### ✅ 已覆盖（可恢复）
- **用户数据**：`auth.db`（RagflowAuth 数据库）
- **RAGFlow 数据**：MySQL、Elasticsearch、MinIO、Redis volumes
- **RAGFlow 配置**：`docker-compose.yml`
- **传输机制**：SCP 自动下载/上传

### ❌ 未覆盖（无法恢复）
- **操作系统**：CentOS/RHEL 系统文件
- **Docker 引擎**：Docker 安装和配置
- **Docker 镜像**：`ragflowauth-backend:local`、`ragflowauth-frontend:local`
- **容器配置**：容器启动参数、环境变量、挂载点
- **网络配置**：Docker 网络、防火墙规则
- **系统服务**：SSH、Docker daemon 配置
- **SSH 密钥**：服务器访问凭据

---

## 灾难场景分析

### 🔴 完全无法恢复的场景（需要完全重建）

#### 1. **系统盘损坏（OS 盘）**
**影响**：
- 操作系统无法启动
- 无法访问任何服务
- 无法 SSH 连接

**恢复时间**：4-8 小时
**恢复步骤**：
1. 重新安装操作系统（CentOS/RHEL）
2. 安装 Docker 和 Docker Compose
3. 配置防火墙和网络
4. 运行完整部署脚本

**预防措施**：
- ❌ 当前无
- ✅ 建议：系统盘 RAID 1
- ✅ 建议：定期系统级快照（云服务商支持）

---

#### 2. **服务器物理损坏（火灾、水灾、硬件故障）**
**影响**：
- 完全无法访问服务器
- 需要更换硬件

**恢复时间**：1-3 天（取决于硬件采购）
**恢复步骤**：
1. 获取新服务器
2. 重新安装系统
3. 从本地备份恢复数据
4. 重新部署应用

**预防措施**：
- ❌ 当前无
- ✅ 建议：异地备份（将备份上传到另一台服务器或云存储）
- ✅ 建议：灾难恢复备用服务器

---

#### 3. **Docker 引擎完全损坏**
**影响**：
- 所有容器无法运行
- Docker 命令失败
- Volume 数据可能完好（但无法访问）

**恢复时间**：2-4 小时
**恢复步骤**：
1. 卸载损坏的 Docker
2. 重新安装 Docker
3. 重新创建 Docker 网络
4. 拉取/导入 Docker 镜像
5. 使用备份恢复 volumes
6. 重新创建并启动容器

**当前风险**：
- ⚠️ Docker 镜像未备份（`ragflowauth-backend:local` 丢失需要重新构建）

**预防措施**：
- ✅ 建议：定期导出 Docker 镜像
- ✅ 建议：保存镜像构建脚本（已有 `deploy.ps1`）

---

#### 4. **勒索软件/恶意软件攻击**
**影响**：
- 所有文件被加密
- 系统完全不可用
- 备份文件也可能被加密（如果备份在同一服务器）

**恢复时间**：1-3 天（取决于攻击范围）
**恢复步骤**：
1. 隔离受感染系统
2. 格式化系统盘
3. 重新安装操作系统
4. 从**离线备份**恢复（确保备份未被感染）

**当前风险**：
- 🔴 **高危**：备份在本地 Windows 和服务器上，都可能被攻击

**预防措施**：
- ✅ **必须**：异地离线备份（不可通过网络访问的备份）
- ✅ **必须**：定期备份验证（确保备份可用）
- ✅ 建议：防病毒软件
- ✅ 建议：最小权限原则

---

### 🟡 部分可恢复的场景（需要额外步骤）

#### 5. **数据盘损坏（/opt/ragflowauth）**
**影响**：
- 应用数据丢失
- Docker volumes 损坏
- 镜像可能丢失

**恢复时间**：1-2 小时
**恢复步骤**：
1. 更换/修复数据盘
2. 重新创建目录结构
3. 从本地 Windows 恢复备份
4. 运行恢复脚本

**当前状态**：✅ 可恢复（已有完整备份恢复机制）

---

#### 6. **容器配置丢失**
**影响**：
- 容器无法启动（不知道启动参数）
- 挂载点配置丢失

**恢复时间**：30 分钟 - 1 小时
**恢复步骤**：
1. 从本地 `tool/scripts/remote-deploy.sh` 获取配置
2. 手动重新创建容器

**当前风险**：
- ⚠️ 需要依赖本地脚本

**预防措施**：
- ✅ 建议：将部署脚本备份到配置管理仓库（Git）

---

#### 7. **SSH 密钥丢失/无法登录**
**影响**：
- 无法远程访问服务器
- 必须通过物理控制台访问

**恢复时间**：30 分钟 - 1 小时
**恢复步骤**：
1. 通过服务器提供商的控制台登录
2. 重置 SSH 密钥或密码
3. 重新配置访问权限

**预防措施**：
- ✅ 建议：保存 SSH 密钥备份在安全位置
- ✅ 建议：多个管理员账号

---

#### 8. **网络配置错误（防火墙、路由）**
**影响**：
- 服务无法从外网访问
- 容器间网络通信失败

**恢复时间**：15-30 分钟
**恢复步骤**：
1. 通过本地控制台访问
2. 重置防火墙规则
3. 重新配置 Docker 网络

**当前状态**：✅ 可恢复（配置相对简单）

---

### 🟢 已覆盖的场景（当前机制可恢复）

#### 9. **数据库损坏（auth.db）**
**当前状态**：✅ 已覆盖
- 备份频率：手动/定时
- RTO（恢复时间目标）：10 分钟
- RPO（恢复点目标）：最近一次备份

---

#### 10. **RAGFlow 数据丢失**
**当前状态**：✅ 已覆盖
- MySQL、ES、MinIO、Redis volumes 均已备份
- 恢复流程已验证

---

#### 11. **误删除数据**
**当前状态**：✅ 已覆盖
- 可以从备份恢复到任意时间点

---

#### 12. **容器崩溃**
**当前状态**：✅ 已覆盖
- 数据在 volumes 中，容器重启后数据不变
- 如需恢复数据，可从备份恢复

---

## 当前系统风险评估

### 高风险项 🔴
1. **无异地备份**：备份仅在本地 Windows 和服务器上
   - 风险：勒索软件、本地灾难（火灾、水灾）
   - 影响：数据永久丢失

2. **Docker 镜像未备份**
   - 风险：镜像丢失后需要重新构建
   - 影响：恢复时间增加 1-2 小时

3. **部署脚本未版本控制**
   - 风险：本地文件丢失后无法重建容器
   - 影响：需要手动重新配置

### 中风险项 🟡
1. **无自动化灾难恢复演练**
   - 风险：实际灾难时恢复流程不熟悉
   - 影响：恢复时间延长

2. **无监控和告警**
   - 风险：问题发现不及时
   - 影响：RTO 延长

3. **无系统级备份**
   - 风险：系统盘损坏需要完全重装
   - 影响：恢复时间 4-8 小时

---

## 改进建议（优先级排序）

### 🔴 紧急（P0）
1. **实现异地备份**
   - 将备份自动上传到远程服务器/云存储
   - 成本：低
   - 收益：避免单点故障

2. **定期备份验证**
   - 每月测试一次恢复流程
   - 成本：低
   - 收益：确保备份可用

### 🟡 重要（P1）
3. **备份 Docker 镜像**
   - 导出关键镜像（ragflowauth-backend:local）
   - 成本：低（磁盘空间）
   - 收益：减少恢复时间

4. **部署脚本版本控制**
   - 将 `tool/` 目录纳入 Git 管理
   - 成本：低
   - 收益：配置可追溯、易恢复

5. **系统盘快照**
   - 如果使用云服务器，启用定期快照
   - 成本：中（云存储费用）
   - 收益：快速恢复系统

### 🟢 建议（P2）
6. **监控和告警**
   - 监控磁盘空间、容器健康状态
   - 成本：低
   - 收益：及时发现问题

7. **文档化灾难恢复流程**
   - 创建详细的恢复手册
   - 成本：低
   - 收益：减少恢复时的混乱

8. **RAID 1 系统盘**
   - 硬件层面保护系统盘
   - 成本：中（需要额外硬盘）
   - 收益：防止硬盘故障

---

## 备份策略建议

### 三层备份策略

```
┌─────────────────────────────────────────────────┐
│  第 1 层：本地实时备份                            │
│  - 服务器：/opt/ragflowauth/data/backups        │
│  - 本地：D:\datas\                               │
│  - RPO: 手动触发                                 │
│  - RTO: 10 分钟                                  │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│  第 2 层：异地备份（建议添加）                     │
│  - 远程服务器：172.27.160.1（或云存储）          │
│  - 频率：每次备份后自动上传                       │
│  - RPO: 同第 1 层                                 │
│  - RTO: 1-2 小时（下载+恢复）                     │
└─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│  第 3 层：离线备份（建议添加）                     │
│  - 外置硬盘：每月导出一次，离线存储               │
│  - RPO: 1 个月                                   │
│  - RTO: 4-8 小时（物理获取+恢复）                 │
└─────────────────────────────────────────────────┘
```

---

## 灾难恢复演练计划

### 每月演练（1 小时）
1. 在测试环境恢复最新备份
2. 验证数据完整性
3. 记录恢复时间
4. 更新恢复文档

### 每季度演练（半天）
1. 模拟服务器完全损坏
2. 在新服务器上完整重建
3. 测试所有功能
4. 优化恢复流程

### 每年演练（1 天）
1. 异地灾难恢复测试
2. 验证离线备份
3. 团队协同演练

---

## 恢复时间目标（RTO）和恢复点目标（RPO）

| 灾难类型 | 当前 RTO | 当前 RPO | 建议改进后 RTO |
|---------|---------|---------|--------------|
| 数据库损坏 | 10 分钟 | 手动备份 | 10 分钟 |
| RAGFlow 数据丢失 | 30 分钟 | 手动备份 | 30 分钟 |
| 容器崩溃 | 30 分钟 | N/A | 15 分钟 |
| 数据盘损坏 | 1-2 小时 | 手动备份 | 1 小时 |
| Docker 引擎损坏 | 2-4 小时 | N/A | 1 小时 |
| 系统盘损坏 | 4-8 小时 | N/A | 30 分钟（快照） |
| 服务器物理损坏 | 1-3 天 | 手动备份 | 4-8 小时 |
| 勒索软件攻击 | 1-3 天 | N/A | 1-2 天 |

---

## 总结

### 当前状态
- ✅ **应用数据备份**：完善
- ✅ **恢复机制**：已验证
- ❌ **异地备份**：缺失
- ❌ **系统级备份**：缺失
- ❌ **镜像备份**：缺失

### 最危险的场景
1. **勒索软件攻击** - 可能导致所有数据永久丢失
2. **服务器物理损坏** - 需要 1-3 天恢复
3. **系统盘损坏** - 需要 4-8 小时重装系统

### 立即行动项
1. ✅ 实现异地自动备份（最紧急）
2. ✅ 定期验证备份可用性
3. ✅ 导出并保存 Docker 镜像
4. ✅ 文档化灾难恢复流程
