# Playwright 测试方案（前后端联动）

## 1) 设计原则
- 稳定优先：优先 `data-testid`、语义选择器，减少对文案脆弱依赖。
- 分层执行：`smoke`（快）+ `regression`（全）+ `integration`（真实联调）。
- 可定位：失败必须有 trace/screenshot/video 和步骤日志。

## 2) 用例分层
- `@smoke`：登录、路由、核心页签可打开。
- `@regression`：每个页签主路径 + 权限分支 + 常见异常。
- `@integration`：真实后端/索引/审批链路。

## 3) 环境矩阵
- 本地：后端 `python -m backend`，前端 `cd fronted && npm start`。
- 环境变量建议：
  - `E2E_FRONTEND_BASE_URL`
  - `E2E_OUTPUT_DIR`
  - `E2E_BACKEND_MODE=mock|real`

## 4) 账号与权限矩阵
- `admin`：全权限。
- `viewer`：仅查看。
- `uploader`：上传相关能力。
- `reviewer`：审批能力（同意/驳回）。
- 断言重点：按钮显隐 + API 状态码 + 实际结果一致。

## 5) 数据策略
- 固定测试知识库前缀：`__e2e_*`。
- 固定夹具文件：`md/pdf/docx/xlsx/xls/csv/txt`。
- 每条 integration 用例后清理创建的对话/文档/知识库。

## 6) 关键业务链（必须覆盖）
- 上传 -> 审批同意 -> 可搜索 -> 可对话引用 -> 日志可追溯。
- 上传 -> 审批驳回 -> 不可搜索 -> 日志可追溯。
- 删除文档 -> 搜索不可命中 -> 日志记录删除动作。
- 修改密码 -> 旧密码失败、新密码成功 -> 日志记录修改密码。

## 7) 索引一致性断言（上传/删除与搜索联动）
- 上传后：轮询等待索引完成，再断言“可搜到”。
- 删除后：轮询等待索引清理，再断言“搜不到”。
- 轮询超时：输出当前索引状态，避免误判为前端问题。

## 8) 日志完整性断言
- 至少覆盖并校验日志存在：
  - 登录、登出
  - 查看（预览）
  - 上传、删除、下载
  - 审批同意、审批驳回
  - 修改密码
- 校验过滤条件：类型/公司/部门/账号/时间区间/组合过滤 + 总数。

## 9) 一键执行与报告
- `npm run e2e`
- `npm run e2e:smoke`
- `npm run e2e:integration`
- `npm run e2e:report`

## 10) 失败定位流程
- 按用例 ID 定位模块（见 `test-items.md`）。
- 看 trace 回放 + network + console。
- 归因为：前端状态、后端 contract、权限配置、测试数据污染、依赖异常。

## 11) 实施顺序
- M1：`smoke` + 权限矩阵基础。
- M2：上传/审批/搜索联动全链路。
- M3：日志完整性与过滤组合断言。
- M4：剩余管理页与边界异常补齐。
