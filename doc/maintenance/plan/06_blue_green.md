# 06 A/B（蓝绿）升级方案（稳定优先）

目标：

- 永远保留两套可运行版本（A/B）
- 当前跑 A → 更新 B → 验证 OK → 切到 B
- 更新失败不影响线上（A 不动）
- 一键回切（秒级）

## 推荐做法（概念方案）

### 1) 两套目录

- `/opt/ragflowauth/slots/A/`
- `/opt/ragflowauth/slots/B/`
- `/opt/ragflowauth/shared/`（共享数据目录：`auth.db`/uploads 等）

### 2) 入口网关

使用 Nginx/Traefik 做“统一入口”，把内网访问固定到一个地址/端口：

- 外部固定入口：`http://server:8080`
- 网关内部转发到 A 或 B 的端口

这样 A/B 可以同时运行，不抢占同一个端口。

### 3) 升级流程（建议）

1) 判断当前 active 是 A 还是 B
2) 把 ZIP 解压到非 active 槽位
3) 启动非 active 槽位并做健康检查（不接入用户流量）
4) 切换网关指向新的槽位
5) 保留旧槽位作为回滚

## 数据注意事项

- `auth.db` 建议放在共享目录（两套都挂载同一份）
- 任何时刻只让“active 槽位”对外提供写入服务（避免双写）

> 蓝绿升级需要配合“部署脚本/运维面板”实现具体落地。后续可在运维面板里把“上传 ZIP → 部署到非活跃 → 一键切换/回滚”做成按钮。

