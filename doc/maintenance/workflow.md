# 工作、测试、发布与备份流程（SOP）

更新日期：2026-01-30

本 SOP 适用的物理架构：
- 本地开发机：Windows（用于开发调试）
- 测试服务器：`http://172.30.30.58/`（Docker 环境）
- 生产服务器：`http://172.30.30.57/`（Docker 环境）

相关账号/密码等敏感信息不在本文重复，统一放在：`doc/maintenance/current/server_config.md`

---

## 1. 本地开发（Windows）

目标：快速迭代与自测，不影响服务器环境。

建议流程：
1) 拉取/更新代码（保持与远端一致）
2) 本地启动前端（热更新）+ 本地启动后端（或联调测试后端）
3) 完成单功能自测后，再进入测试服务器验证

关键自测点（最少集）：
- 登录/刷新 token
- 文档上传（含大文件/多文件/格式校验）
- 文档预览（pdf/docx/xlsx/csv 等）
- 管理端功能（用户管理、改密等）

---

## 2. 测试服务器验证（Staging/Test）

目标：在“与生产一致”的 Docker/compose 环境里验证功能、配置与依赖。

建议流程（每次发布到测试环境）：
1) 在测试服务器拉取最新代码或发布包
2) 构建并启动服务（Docker compose）
3) 完成冒烟测试（smoke）
4) 验证通过后，才能进入生产发布

冒烟测试清单（建议写成固定 checklist）：
- 页面可访问、静态资源加载无报错（含 `.mjs` MIME）
- 登录正常（无 500/数据库可用）
- 上传正常（无 413；大小限制符合预期）
- 预览正常（pdf/docx/xlsx/csv；必要时走“原样预览”）
- 审核/下载/删除权限校验正常
- 备份功能能跑通一次（产出迁移包目录/manifest）

---

## 3. 生产服务器发布（Production）

目标：最小风险上线，支持快速回滚。

推荐原则：
- 生产发布只发布“已在测试环境验证通过”的同一版本（同 commit/tag/镜像）
- 保留上一个可用版本，出问题可快速回滚

建议流程（一次生产发布）：
1) 确认测试服务器验证通过（记录版本号/commit/tag）
2) 生产服务器获取同一版本
3) 生产服务器滚动/重启服务
4) 发布后冒烟测试（同测试环境清单，但更保守）
5) 记录发布信息（时间、版本、变更点、回滚点）

回滚策略（建议固定）：
- 保留上一版镜像与配置（`.env`/compose）
- 出现严重问题时，直接切回上一版并重启服务

---

## 4. 定时备份策略

目标：满足“可恢复”，而不是“有备份文件”。

建议备份内容分层：
- 每日数据备份（Daily）
  - `auth.db`
  - `uploads/`（如果启用且重要）
  - 关键配置文件（例如 `ragflow_config.json`、compose/.env）
- 每周镜像备份（Weekly）
  - `docker save` 导出的 images 包（体积大，频率低合理）

保留策略（示例）：
- Daily：保留最近 14~30 天
- Weekly：保留最近 4~8 周

恢复演练（强烈建议）：
- 每月至少抽查 1 次：从备份恢复到一台临时环境并验证可登录/可查询/可预览

---

## 5. 自动化（Cron/Systemd Timer）

目标：把“每天/每周”变成稳定可追踪的自动任务。

建议做法：
- 在服务器上用 cron 或 systemd timer 定时触发“立即备份”
- 将备份输出到一个稳定目录（建议挂载到容器可见路径）
- 将任务输出日志落盘（便于排查失败原因）

备注：
- 如果需要把备份写入远端 Windows 电脑，建议通过 SMB/CIFS 挂载到服务器后再写入该挂载点（比在容器里拼 UNC 路径更稳定）。

