# Docker é•œåƒç®¡ç†å’Œæ¸…ç†æœºåˆ¶

## é—®é¢˜æè¿°

æ¯æ¬¡éƒ¨ç½²éƒ½ä¼šåœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºæ–°çš„ Docker é•œåƒç‰ˆæœ¬ï¼Œå¦‚æœä¸å®šæœŸæ¸…ç†ï¼Œä¼šå ç”¨å¤§é‡ç£ç›˜ç©ºé—´ã€‚ç‰¹åˆ«æ˜¯ RagflowAuth çš„é•œåƒåŒ…å«åç«¯ï¼ˆ~319MBï¼‰å’Œå‰ç«¯ï¼ˆ~61MBï¼‰ï¼Œå¤šæ¬¡éƒ¨ç½²åä¼šç§¯ç´¯å¤šä¸ªç‰ˆæœ¬ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. è‡ªåŠ¨æ¸…ç†æœºåˆ¶

éƒ¨ç½²è„šæœ¬ `deploy.ps1` ç°åœ¨åŒ…å«è‡ªåŠ¨æ¸…ç†æ­¥éª¤ï¼š

- **è§¦å‘æ—¶æœº**: æ¯æ¬¡éƒ¨ç½²å®Œæˆæ—¶è‡ªåŠ¨æ‰§è¡Œ
- **ä¿ç•™ç­–ç•¥**: ä»…ä¿ç•™å½“å‰è¿è¡Œçš„ç‰ˆæœ¬ï¼ˆ`--keep 1`ï¼‰ï¼Œåˆ é™¤æ‰€æœ‰å…¶ä»–ç‰ˆæœ¬
- **å®‰å…¨ä¿æŠ¤**: ç»ä¸åˆ é™¤æ­£åœ¨è¿è¡Œçš„å®¹å™¨æ‰€ä½¿ç”¨çš„é•œåƒ
- **æƒè¡¡**: èŠ‚çœç£ç›˜ç©ºé—´ vs å¤±å»å¿«é€Ÿå›æ»šèƒ½åŠ›

**å¦‚éœ€ä¿ç•™å›æ»šèƒ½åŠ›**ï¼Œä½¿ç”¨ `--keep 2` æˆ–æ›´é«˜ï¼š
```bash
/tmp/cleanup-images.sh --keep 2  # ä¿ç•™æœ€è¿‘ 2 ä¸ªç‰ˆæœ¬
```

### 2. æ‰‹åŠ¨æ¸…ç†è„šæœ¬

**ä½ç½®**: `tool/scripts/cleanup-images.sh`

**åŸºæœ¬ç”¨æ³•**:
```bash
# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp tool/scripts/cleanup-images.sh root@172.30.30.57:/tmp/

# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
ssh root@172.30.30.57
chmod +x /tmp/cleanup-images.sh
/tmp/cleanup-images.sh
```

**é«˜çº§é€‰é¡¹**:
```bash
# é¢„è§ˆæ¨¡å¼ï¼ˆä¸å®é™…åˆ é™¤ï¼Œå®‰å…¨ï¼‰
/tmp/cleanup-images.sh --dry-run

# ä¿ç•™æœ€è¿‘ 3 ä¸ªç‰ˆæœ¬
/tmp/cleanup-images.sh --keep 3

# ä½¿ç”¨è‡ªå®šä¹‰ç”Ÿäº§ tag
/tmp/cleanup-images.sh --production-tag latest
```

### 3. å¿«é€Ÿé‡å¯è„šæœ¬

**ä½ç½®**: `tool/scripts/quick-restart.sh`

**ç”¨é€”**: é•œåƒå·²ä¼ è¾“åˆ°æœåŠ¡å™¨åï¼Œå¿«é€Ÿé‡å¯å®¹å™¨ï¼ˆä¸é‡æ–°æ„å»ºï¼‰

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
/opt/ragflowauth/quick-restart.sh --tag 2025-01-25-scheduler-fix-v2
```

## å·¥ä½œåŸç†

### æ¸…ç†è„šæœ¬é€»è¾‘

1. **è¯†åˆ«æ­£åœ¨ä½¿ç”¨çš„é•œåƒ**:
   - æ£€æŸ¥å½“å‰è¿è¡Œçš„å®¹å™¨
   - è®°å½•è¿è¡Œä¸­å®¹å™¨ä½¿ç”¨çš„é•œåƒ ID

2. **ä¿ç•™ç­–ç•¥**:
   - å§‹ç»ˆä¿ç•™æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä½¿ç”¨çš„é•œåƒ
   - ä¿ç•™æœ€è¿‘ N ä¸ªç‰ˆæœ¬çš„é•œåƒï¼ˆé»˜è®¤ 2ï¼‰
   - æŒ‰é•œåƒåˆ›å»ºæ—¶é—´æ’åºï¼Œä¿ç•™æœ€æ–°çš„

3. **åˆ é™¤æ—§é•œåƒ**:
   - åˆ é™¤æ‰€æœ‰æœªè¢«ä¿ç•™çš„é•œåƒ
   - æ¸…ç†æ‚¬ç©ºé•œåƒï¼ˆdangling imagesï¼‰
   - æ˜¾ç¤ºé‡Šæ”¾çš„ç£ç›˜ç©ºé—´

### ç¤ºä¾‹åœºæ™¯

**åœºæ™¯ 1: æ­£å¸¸éƒ¨ç½²ï¼ˆé»˜è®¤æ¸…ç†ç­–ç•¥ï¼‰**
```bash
# 1. æœ¬åœ°æ„å»º
docker compose build

# 2. æ‰“æ ‡ç­¾
docker tag ragflowauth-backend:local ragflowauth-backend:v1.0
docker tag ragflowauth-frontend:local ragflowauth-frontend:v1.0

# 3. éƒ¨ç½²ï¼ˆè‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬ï¼‰
.\tool\scripts\deploy.ps1 -Tag v1.0

# è‡ªåŠ¨æ‰§è¡Œ:
# - ä¼ è¾“é•œåƒ
# - å¯åŠ¨æ–°å®¹å™¨
# - æ¸…ç†æ‰€æœ‰æ—§é•œåƒï¼ˆä»…ä¿ç•™å½“å‰è¿è¡Œç‰ˆæœ¬ï¼‰
```

**åœºæ™¯ 2: ä¿ç•™å›æ»šç‰ˆæœ¬**
```bash
# éƒ¨ç½²æ—¶ä¿ç•™æœ€è¿‘ 3 ä¸ªç‰ˆæœ¬
scp tool/scripts/cleanup-images.sh root@172.30.30.57:/tmp/
ssh root@172.30.30.174 "/tmp/cleanup-images.sh --keep 3"
```

**åœºæ™¯ 3: å¿«é€Ÿé‡å¯**
```bash
# é•œåƒå·²å­˜åœ¨ï¼Œåªéœ€é‡å¯å®¹å™¨
ssh root@172.30.30.57 "/opt/ragflowauth/quick-restart.sh --tag v1.0"
```

**åœºæ™¯ 4: æ‰‹åŠ¨æ¸…ç†**
```bash
# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
ssh root@172.30.30.57 "docker system df"

# é¢„è§ˆæ¸…ç†
ssh root@172.30.30.57 "/tmp/cleanup-images.sh --dry-run"

# æ‰§è¡Œæ¸…ç†ï¼ˆé»˜è®¤ä»…ä¿ç•™å½“å‰ç‰ˆæœ¬ï¼‰
ssh root@172.30.30.57 "/tmp/cleanup-images.sh"
```

## æœ€ä½³å®è·µ

### âš ï¸ é‡è¦æç¤ºï¼šæ¸…ç†ç­–ç•¥æƒè¡¡

**é»˜è®¤ç­–ç•¥ (`--keep 1`)**ï¼š
- âœ… **ä¼˜ç‚¹**: æœ€å¤§ç¨‹åº¦èŠ‚çœç£ç›˜ç©ºé—´ï¼Œæ¯æ¬¡éƒ¨ç½²åªä¿ç•™ä¸€ä¸ªç‰ˆæœ¬
- âŒ **ç¼ºç‚¹**: å¤±å»å¿«é€Ÿå›æ»šèƒ½åŠ›ï¼Œæ— æ³•è½»æ˜“å›åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
- ğŸ¯ **é€‚ç”¨åœºæ™¯**: ç£ç›˜ç©ºé—´ç´§å¼ ï¼Œæˆ–é€šè¿‡å…¶ä»–æ–¹å¼ï¼ˆå¦‚ Gitï¼‰ç®¡ç†ç‰ˆæœ¬

**ä¿ç•™ç­–ç•¥ (`--keep 2` æˆ–æ›´é«˜)**ï¼š
- âœ… **ä¼˜ç‚¹**: ä¿ç•™å›æ»šèƒ½åŠ›ï¼Œå¯ä»¥å¿«é€Ÿå›åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
- âŒ **ç¼ºç‚¹**: å ç”¨æ›´å¤šç£ç›˜ç©ºé—´ï¼ˆæ¯ä¸ªç‰ˆæœ¬çº¦ 380MBï¼‰
- ğŸ¯ **é€‚ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒéœ€è¦å¿«é€Ÿå›æ»šèƒ½åŠ›

**ä¿®æ”¹é»˜è®¤ä¿ç•™ç­–ç•¥**ï¼š
```bash
# åœ¨ deploy.ps1 ä¸­ä¿®æ”¹
# å°† --keep 1 æ”¹ä¸º --keep 2

# æˆ–æ‰‹åŠ¨è¿è¡Œæ¸…ç†æ—¶æŒ‡å®š
/tmp/cleanup-images.sh --keep 3
```

### 1. ä½¿ç”¨å›ºå®šçš„ Tag ç­–ç•¥

**æ¨èç­–ç•¥**: ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼ˆSemantic Versioningï¼‰

```bash
# å¼€å‘ç‰ˆæœ¬
docker tag ragflowauth-backend:local ragflowauth-backend:dev

# æµ‹è¯•ç‰ˆæœ¬
docker tag ragflowauth-backend:local ragflowauth-backend:v1.0.0-beta.1

# ç”Ÿäº§ç‰ˆæœ¬
docker tag ragflowauth-backend:local ragflowauth-backend:v1.0.0
```

**ä¸æ¨è**: ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ tag
```bash
# è¿™æ ·ä¼šäº§ç”Ÿå¤§é‡æ—§é•œåƒ
docker tag ragflowauth-backend:local ragflowauth-backend:2025-01-26-15-30-45
```

### 2. å®šæœŸç»´æŠ¤

å»ºè®®å®šæœŸï¼ˆæ¯å‘¨æˆ–æ¯æœˆï¼‰æ£€æŸ¥å¹¶æ¸…ç†é•œåƒï¼š

```bash
# åˆ›å»º cron ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ æ¯å‘¨æ—¥å‡Œæ™¨ 3 ç‚¹æ¸…ç†
0 3 * * 0 /tmp/cleanup-images.sh --keep 2 > /var/log/ragflow-cleanup.log 2>&1
```

### 3. ç›‘æ§ç£ç›˜ä½¿ç”¨

```bash
# æŸ¥çœ‹ Docker æ€»ä½“ç£ç›˜ä½¿ç”¨
docker system df

# è¯¦ç»†æŸ¥çœ‹é•œåƒå¤§å°
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"

# æŸ¥çœ‹æ‚¬ç©ºé•œåƒ
docker images -f "dangling=true"
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ¸…ç†è„šæœ¬æ— æ³•åˆ é™¤é•œåƒ

**åŸå› **: é•œåƒå¯èƒ½è¢«å…¶ä»–å®¹å™¨ä½¿ç”¨

**è§£å†³**:
```bash
# æ£€æŸ¥å“ªäº›å®¹å™¨åœ¨ä½¿ç”¨è¯¥é•œåƒ
docker ps -a --filter ancestor=ragflowauth-backend:old-version

# åœæ­¢å¹¶åˆ é™¤è¿™äº›å®¹å™¨
docker stop <container_id>
docker rm <container_id>

# é‡æ–°è¿è¡Œæ¸…ç†è„šæœ¬
/tmp/cleanup-images.sh
```

### é—®é¢˜ 2: æ¸…ç†åç£ç›˜ç©ºé—´æœªé‡Šæ”¾

**åŸå› **: Docker å¯èƒ½ä¿ç•™äº†æ‚¬ç©ºå·æˆ–æ„å»ºç¼“å­˜

**è§£å†³**:
```bash
# æ¸…ç†æ‚¬ç©ºå·
docker volume prune -f

# æ¸…ç†æ„å»ºç¼“å­˜
docker builder prune -f

# å…¨é¢æ¸…ç†ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
docker system prune -a --volumes
```

### é—®é¢˜ 3: æ¢è¡Œç¬¦é”™è¯¯

**é”™è¯¯ä¿¡æ¯**: `/bin/bash^M: è§£é‡Šå™¨é”™è¯¯`

**åŸå› **: Windows æ¢è¡Œç¬¦ï¼ˆCRLFï¼‰vs Unix æ¢è¡Œç¬¦ï¼ˆLFï¼‰

**è§£å†³**:
```bash
# è½¬æ¢æ¢è¡Œç¬¦
sed -i 's/\r$//' /tmp/cleanup-images.sh
chmod +x /tmp/cleanup-images.sh
```

## æ€»ç»“

é€šè¿‡è‡ªåŠ¨å’Œæ‰‹åŠ¨æ¸…ç†æœºåˆ¶ç›¸ç»“åˆï¼Œå¯ä»¥æœ‰æ•ˆæ§åˆ¶æœåŠ¡å™¨ä¸Šçš„ Docker é•œåƒæ•°é‡ï¼š

- âœ… **è‡ªåŠ¨åŒ–**: éƒ¨ç½²æ—¶è‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
- âœ… **å®‰å…¨**: ä¿ç•™æœ€è¿‘ç‰ˆæœ¬ï¼Œæ”¯æŒå¿«é€Ÿå›æ»š
- âœ… **çµæ´»**: å¯é…ç½®ä¿ç•™ç­–ç•¥ï¼Œé€‚åº”ä¸åŒéœ€æ±‚
- âœ… **é€æ˜**: é¢„è§ˆæ¨¡å¼æ˜¾ç¤ºå°†è¦åˆ é™¤çš„å†…å®¹ï¼Œé¿å…è¯¯åˆ 

å®šæœŸæ‰§è¡Œæ¸…ç†å¯ä»¥ä¿æŒæœåŠ¡å™¨ç£ç›˜ç©ºé—´å¥åº·ï¼Œé¿å…å› é•œåƒç§¯ç´¯å¯¼è‡´ç£ç›˜ç©ºé—´ä¸è¶³ã€‚
