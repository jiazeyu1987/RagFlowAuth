# 运维体系落地步骤（空 Linux 服务器，稳定优先）

适用场景：
- 单台空 Linux 服务器
- 内网访问（无 VPN/专线）
- 优先稳定、可恢复、可回滚

> 说明：本步骤是“落地顺序”，不是具体命令手册。命令级操作后续按你服务器发行版再细化。

## 第 1 阶段：把“基础环境”打牢（必须）

1) 服务器初始化
- 确认服务器时间/时区正确
- 规划磁盘：建议单独数据盘（或至少单独数据目录），保证 ES/MinIO 有足够空间
- 配置防火墙/安全组：只开放内网需要的端口

2) 安装 Docker（一次性）
- 安装 Docker Engine + docker compose 插件
- 配置 Docker 开机自启

3) 规划目录（建议）
- 建议：`/opt/ragflowauth/` 作为应用目录
- 建议：`/opt/ragflowauth/data/` 或挂载到 `/data/` 作为持久化数据目录

## 第 2 阶段：先跑通“可部署”（不带数据）

4) 部署发布包（ZIP）
- 把发布 ZIP 拷到服务器
- 解压到目标目录
- 启动我们系统（前端+后端）
- 启动 RAGFlow（如果你希望同机部署）

5) 基本验证
- 前端可打开、可登录
- 后端健康检查正常
- RAGFlow Web 可打开（容器组件都在运行）

> 目标：先证明“这台服务器能把系统跑起来”，避免一上来就陷入数据问题排障。

## 第 3 阶段：跑通“可恢复”（带数据）

6) 准备迁移包（migration_pack）
- 确保你有一份正确的迁移包（包含 `auth.db` + `ragflow/volumes/*.tar.gz`）
- 如果新服务器无法访问外网：迁移包最好包含 `ragflow/images/*.tar`（镜像离线导入）

7) 按正确顺序恢复数据（关键）
- 先启动一次 RAGFlow（让它创建“当前 compose 前缀”的 volumes）
- 停止 RAGFlow（避免写入冲突）
- 恢复迁移包：
  - 覆盖我们系统的 `data/auth.db`
  - 恢复 RAGFlow volumes（MySQL/MinIO/ES/Redis）
  - （可选）导入 RAGFlow 镜像包
- 启动 RAGFlow
- 启动我们系统

8) 数据验证
- 你们系统账号/权限正常
- RAGFlow 知识库/文档/索引正常

## 第 4 阶段：把“备份闭环”落地（稳定性核心）

9) 定时备份策略
- 配置“数据安全”定时备份
- 规划备份保存位置与容量（避免把盘打满）
- 明确保留策略（按天/周/数量）

10) 恢复演练（每周至少一次）
- 在测试机抽样恢复一份迁移包
- 验证登录与关键知识库存在

## 第 5 阶段：把“可观测+低学习成本”落地

11) 运维面板（推荐 Portainer CE）
- 用于：容器状态/日志/重启/卷/网络
- 只开放内网访问、设置强密码

12) 监控与告警（最小可用）
- 磁盘空间告警（ES/MinIO 数据盘最重要）
- 容器重启次数告警
- 服务健康检查告警

## 第 6 阶段：把“可回滚/蓝绿升级”落地（进阶）

13) 先做版本化目录（简单稳）
- 每次更新解压到新目录
- `current` 指向当前版本
- 更新失败可快速切回上一版本目录

14) 再做 A/B（蓝绿）升级（最稳）
- A/B 两套同时存在
- 通过网关（Nginx/Traefik）切换入口
- 更新只在非活跃槽位进行，验证通过再切换

---

## 落地前需要你确认的两个输入

- 服务器发行版：Ubuntu / Debian / CentOS / Rocky / Alibaba Cloud Linux
- 数据目录规划：是否有单独数据盘（建议挂载到 `/data` 或 `/opt/ragflowauth/data`）

